<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Botões Overlay Power BI</title>
  <style>
    body { font-family: Arial, sans-serif; }

    iframe[src*="app.powerbi.com"] ~ div .zoomLevelWrapper {
      display: none !important;
    }

    #reportContainer {
      width: 100%;
      max-width: 1440px;
      aspect-ratio: 16 / 9;
      height: auto;
      border: 1px solid #ccc;
      position: relative;
      margin-top: 20px;
    }

    #reportContainer iframe {
      width: 100% !important;
      height: 100% !important;
      position: absolute;
      inset: 0;
      border: none;
      z-index: 1;
    }

    .overlay-button {
      position: absolute;
      width: 30px;
      height: 30px;
      background-size: contain;
      background-repeat: no-repeat;
      cursor: pointer;
      z-index: 9999;
      transition: background-image 0.2s ease, transform 0.1s ease;
      display: none;
    }

    #btn-omc.overlay-button {
      width: 20px;
      height: 20px;
    }

    .overlay-button[data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      color: #000;
      border: 1px solid #ccc;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: normal;
      word-wrap: break-word;
      font-size: 12px;
      display: none;
      z-index: 10000;
    }
    .overlay-button[data-tooltip]::before {
      content: "";
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(4px);
      border: 6px solid transparent;
      border-top-color: #fff;
      display: none;
      z-index: 10000;
    }
    .overlay-button[data-tooltip]:hover::before,
    .overlay-button[data-tooltip]:hover::after {
      display: block;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
</head>
<body>
  <h2>Embedding com Botões Overlay</h2>
  <div id="reportContainer"></div>
  <script src="imagens.js"></script>
  <script>
    // Configurações iniciais
    const BASE_WIDTH  = 1280;
    const BASE_HEIGHT = 720;

    const botoes = [
      { id: "btn-titulo",  top: 370, left: 300,  pageId: "99565d61bdef2b12490e", tooltip: "Clique para detalhamento" },
      { id: "btn-defesa",  top: 370, left: 588,  pageId: "d4f2b999f0ce0f03194d", tooltip: "Clique para detalhamento" },
      { id: "btn-extarif", top: 370, left: 875,  pageId: "68441e5f4f6a188dbc42", tooltip: "Clique para detalhamento" },
      { id: "btn-acordos", top: 370, left: 1166, pageId: "ead2708b711235860cd1", tooltip: "Clique para detalhamento" },
      { id: "btn-omc",     top: 290, left: 695,  pageId: "815d5b49b2ecd3e99527", tooltip: "Clique para detalhamento" }
    ];

    const PAGINA_HOME = "721a88aed967955434ca";

    // -------------------------------------------------------------
    // Funções utilitárias
    // -------------------------------------------------------------

    (['touchstart', 'touchmove']).forEach(ev =>
      document.addEventListener(ev, () => {}, { passive: true })
    );

    function showOverlayButtons(visible) {
      document.querySelectorAll('.overlay-button')
        .forEach(btn => btn.style.display = visible ? 'block' : 'none');
    }

    let currentZoom = 1, previousZoom = 1;
    let zoomTimer = null;

    function startZoomLogger(report) {
      if(zoomTimer) return;
      zoomTimer = setInterval(async ()=>{
        try {
          const zoom = await report.getZoom();
          if (zoom !== previousZoom) {
            previousZoom = zoom;
            currentZoom = zoom;
            positionButtons();
          }
        } catch (err) {
          // silenciar
        }
      }, 250);
    }

    function getBrowserZoom() {
      if (window.visualViewport && window.visualViewport.scale) {
        return window.visualViewport.scale;
      }
      return window.devicePixelRatio || 1;
    }

    if (window.visualViewport) {
      visualViewport.addEventListener('resize', positionButtons);
    }

    function positionButtons() {
      const container = document.getElementById('reportContainer');
      const cw = container.clientWidth;
      const ch = container.clientHeight;

      const fitScale     = Math.min(cw / BASE_WIDTH, ch / BASE_HEIGHT);
      const reportScale  = currentZoom;
      const browserScale = getBrowserZoom();
      const totalScale   = fitScale * reportScale * browserScale;

      const contentW = BASE_WIDTH  * totalScale;
      const contentH = BASE_HEIGHT * totalScale;
      const offsetX = (cw - contentW) / 2;
      const offsetY = 0;

      botoes.forEach(({id, top, left}) => {
        const btn = document.getElementById(id);
        if (!btn) return;

        btn.style.left   = `${offsetX + left  * totalScale}px`;
        btn.style.top    = `${offsetY + top   * totalScale}px`;

        const baseSize = (id === 'btn-omc') ? 25 : 30;
        const size     = Math.max(Math.round(baseSize * totalScale), 12);

        btn.style.width  = `${size}px`;
        btn.style.height = `${size}px`;

        // Limites
        const pxLeft = offsetX + left  * totalScale;
        const pxTop  = offsetY + top   * totalScale;
        const isInside =
          pxLeft   >= 0 &&
          pxTop    >= 0 &&
          (pxLeft + size) < cw &&
          (pxTop  + size) < ch;

        if (btn.style.display !== 'none') {
          btn.style.visibility = isInside ? 'visible' : 'hidden';
        }
      });
    }

    async function refreshOverlayButtons(report) {
      const models = window['powerbi-client'].models;
      const page = await report.getActivePage();
      const visuals = await page.getVisuals();
      const cards = visuals.filter(v => v.type === 'cardVisual');

      const mappings = [
        { title: 'Título Exceção',      field: 'titulo_excecao',         id: 'btn-titulo'  },
        { title: 'Países Defesa',       field: 'contagem_paises_defesa', id: 'btn-defesa'  },
        { title: 'Ex-Tarifários',       field: 'contagem_ex_tarifarios', id: 'btn-extarif' },
        { title: 'Acordos Comerciais',  field: 'contagem_paises_acordos',id: 'btn-acordos' },
        { title: 'Códigos OMC',         field: 'contagem_codigos_omc',   id: 'btn-omc'     }
      ];

      for (let map of mappings) {
        const vis = cards.find(c => c.title === map.title);
        const btn = document.getElementById(map.id);
        if (!vis || !btn) continue;

        try {
          const data = await vis.exportData(models.ExportDataType.Summarized, 1);
          let value;

          if (Array.isArray(data.data)) {
            value = data.data[0][map.field];
          } else if (typeof data.data === 'string') {
            const linhas = data.data.split('\n');
            value = linhas.length > 1 ? linhas[1] : '';
          } else {
            value = '';
          }

          const normalized = String(value ?? '').trim();

          const show = (map.id === 'btn-omc')
            ? !isNaN(normalized) && Number(normalized) > 1
            : Boolean(normalized && !['-', "'-", '0'].includes(normalized));

          btn.style.display = show ? 'block' : 'none';
        } catch (err) {
          btn.style.display = 'none';
        }
      }
    }

    async function sincronizaSlicerNCM(report, valor) {
      const models = window['powerbi-client'].models;
      const page   = await report.getActivePage();
      const visual = (await page.getVisuals()).find(v => v.type === "slicer");
      if (!visual) return;
      const estado = await visual.getSlicerState();
      estado.filters = [{
        $schema: "http://powerbi.com/product/schema#basic",
        filterType: models.FilterType.Basic,
        target:     estado.targets[0],
        operator:   "In",
        values:     [valor]
      }];
      await visual.setSlicerState(estado);
    }

    async function embedReport(cfg) {
      const models = window['powerbi-client'].models;
      const filter = getFilterFromUrl(models);

      let codigoUrl = null;
      if (filter) {
        if (filter.filterType === models.FilterType.Basic) {
          codigoUrl = filter.values[0];
        } else if (filter.filterType === models.FilterType.Advanced) {
          codigoUrl = filter.conditions[0].value;
        }
      }

      const config = {
        type: 'report',
        tokenType: models.TokenType.Embed,
        accessToken: cfg.accessToken,
        embedUrl: cfg.embedUrl,
        id: cfg.reportId,
        permissions: models.Permissions.All,
        settings: {
          panes: { filters: { visible: false }, pageNavigation: { visible: false } },
          layoutType: models.LayoutType.Custom,
          customLayout: { displayOption: models.DisplayOption.ActualSize }
        }
      };

      const container = document.getElementById('reportContainer');
      powerbi.reset(container);
      const report = powerbi.embed(container, config);

      report.on('loaded', async () => {
        if (filter) {
          try {
            await report.setFilters([filter]);
          } catch (e) {
            // pode logar
          }
        }

        if(!container._resizeObs){
          const resizeObs = new ResizeObserver(positionButtons);
          resizeObs.observe(container);
          window.addEventListener('resize', positionButtons);
          if (window.visualViewport) {
            visualViewport.addEventListener('resize', positionButtons);
          }
        }

        let firstRender = true;
        report.on('rendered', async () => {
          if (firstRender) {
            if(!document.getElementById('btn-titulo')){
              botoes.forEach(({id, pageId, tooltip}) => {
                const btn = document.createElement('div');
                btn.id = id;
                btn.className = 'overlay-button';
                btn.setAttribute('data-tooltip', tooltip);
                btn.style.backgroundImage = `url('${imagemDefault}')`;
                btn.addEventListener('mouseover', () => btn.style.backgroundImage = `url('${imagemHover}')`);
                btn.addEventListener('mouseout',  () => btn.style.backgroundImage = `url('${imagemDefault}')`);
                btn.addEventListener('mousedown', () => btn.style.transform = 'translate(1px,1px)');
                btn.addEventListener('mouseup',   () => btn.style.transform = 'translate(0,0)');
                btn.addEventListener('click', async () => {
                  try {
                    await report.setPage(pageId);
                    showOverlayButtons(pageId === PAGINA_HOME);
                  } catch (e) {
                    // pode logar
                  }
                });
                container.appendChild(btn);
              });
            }

            if(codigoUrl) {
              await sincronizaSlicerNCM(report, codigoUrl);
            }

            firstRender = false;
          }
          await refreshOverlayButtons(report);
          await report.getZoom().then(z=>currentZoom=previousZoom=z).catch(()=>{});
          startZoomLogger(report);
          positionButtons();
        });

        report.on('pageChanged', async () => {
          showOverlayButtons((await report.getActivePage()).name === PAGINA_HOME);
          await refreshOverlayButtons(report);
          await report.getZoom().then(z=>currentZoom=previousZoom=z).catch(()=>{});
          positionButtons();
        });

        showOverlayButtons(true);
        await refreshOverlayButtons(report);
        positionButtons();
      });

      report.on('error', e => console.error('PowerBI embed error:', e.detail));
    }

    function getFilterFromUrl(models) {
      const params = new URLSearchParams(window.location.search);
      const raw    = params.get('filter');
      if (!raw) return null;
      const [tableField, rawValue] = raw.split(" eq ");
      if (!tableField || !rawValue) return null;
      const [table, column] = tableField.split("/");
      const cleanValue     = rawValue.replace(/'/g, "");
      if (column.toLowerCase() === "codigo_desc") {
        return {
          $schema: "http://powerbi.com/product/schema#advanced",
          filterType: models.FilterType.Advanced,
          target: { table, column },
          logicalOperator: "And",
          conditions: [
            { operator: "Contains", value: cleanValue }
          ]
        };
      }
      return {
        $schema: "http://powerbi.com/product/schema#basic",
        filterType: models.FilterType.Basic,
        target: { table, column },
        operator: "In",
        values: [cleanValue]
      };
    }

    // ---- EMBED REAL ----

    fetch('/api/embed-config')
      .then(resp => resp.json())
      .then(cfg => {
        if(cfg.error){
          alert("Erro ao obter configuração do embed: " + (cfg.details || cfg.error));
          return;
        }
        embedReport(cfg);
      });

  </script>
</body>
</html>
