<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Power BI Embed (App Owns Data)</title>
  <script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
</head>
<body>
  <h2>Painel Power BI</h2>
  <div id="reportContainer" style="width:100%; height:90vh;"></div>
  <script>
    // Função para ler o filtro da URL e montar o objeto para o Power BI
    function getFilterFromUrl(models) {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get('filter');
      if (!raw) return null;

      // Suporta eq, contains, startswith
      const m = raw.match(/^([A-Za-z0-9_]+)\/([A-Za-z0-9_]+)\s*(eq|contains|startswith)\s*'([^']+)'$/i);
      if (!m) return null;
      const [, table, column, op, value] = m;

      if (op === "eq") {
        return {
          $schema: "http://powerbi.com/product/schema#basic",
          filterType: models.FilterType.Basic,
          target: { table, column },
          operator: "In",
          values: [value]
        };
      }
      if (op === "contains" || op === "startswith") {
        return {
          $schema: "http://powerbi.com/product/schema#advanced",
          filterType: models.FilterType.Advanced,
          target: { table, column },
          logicalOperator: "And",
          conditions: [
            { operator: op.charAt(0).toUpperCase() + op.slice(1), value }
          ]
        };
      }
      return null;
    }

    fetch('/api/embed-config')
      .then(r => r.json())
      .then(async config => {
        const models = window['powerbi-client'].models;
        const container = document.getElementById('reportContainer');
        powerbi.reset(container);
        const embedConfig = {
          type: 'report',
          id: config.reportId,
          embedUrl: config.embedUrl,
          accessToken: config.accessToken,
          tokenType: models.TokenType.Embed,
          settings: {
            panes: { filters: { visible: false } }
          }
        };
        const report = powerbi.embed(container, embedConfig);

        // Aplica o filtro se houver na URL
        const filter = getFilterFromUrl(models);
        report.on('loaded', async () => {
          if (filter) {
            try {
              await report.setFilters([filter]);
              console.log('Filtro aplicado:', filter);
            } catch (e) {
              console.warn('Erro ao aplicar filtro:', e);
            }
          }
        });

        report.on('error', e => console.error('PowerBI embed error:', e.detail));
      });
  </script>
</body>
</html>
